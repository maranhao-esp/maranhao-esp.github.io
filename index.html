<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nosso Mundo ‚ù§Ô∏è</title>
    <link rel="manifest" href="./manifest.json">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-messaging-compat.js"></script>

    <style>
        /* MANTENHA O MESMO CSS ANTERIOR */
        :root { --rosa: #ff4f87; --fundo: #fff5f8; }
        html, body { height: 100%; margin: 0; padding: 0; background: var(--fundo); font-family: sans-serif; }
        #login-screen { position: fixed; inset: 0; background: var(--fundo); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 400px; }
        /* ... resto do CSS igual ao anterior ... */
    </style>
</head>
<body>
    <!-- TELA DE LOGIN (mesma do c√≥digo anterior) -->
    <div id="login-screen">
        <div class="login-card">
            <h2 style="color: #ff4f87">Nosso Mundo ‚ù§Ô∏è</h2>
            <button id="btn-google" style="width:100%; padding:15px; border-radius:10px; background:white; border:1px solid #ddd; display:flex; align-items:center; justify-content:center; gap:10px;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Entrar com Google
            </button>
            
            <div id="nickname-box" style="display:none; margin-top:20px;">
                <input id="nickInput" placeholder="Teu apelido..." style="width:100%; padding:12px; border-radius:10px; border:1px solid #ddd; margin-bottom:10px;">
                <button onclick="salvarNick()" style="width:100%; padding:12px; background:#ff4f87; color:white; border:none; border-radius:10px;">Entrar</button>
            </div>
            
            <button id="btn-notificacao" onclick="ativarNotificacoes()" style="width:100%; margin-top:15px; padding:12px; background:#4CAF50; color:white; border:none; border-radius:10px;">
                üîî Ativar Notifica√ß√µes
            </button>
            <div id="status-aviso" style="font-size:12px; margin-top:10px; color:#666;"></div>
        </div>
    </div>

    <!-- APP (mesma estrutura do c√≥digo anterior) -->
    <div id="app-wrapper" style="display:none; height:100dvh; flex-direction:column;">
        <header style="background:white; padding:15px; text-align:center;">
            <div id="contador" style="color:#ff4f87; font-weight:bold;">‚ù§Ô∏è Carregando...</div>
            <div id="status-online" style="font-size:12px; color:#2ecc71;">‚óè Online</div>
        </header>
        
        <!-- Conte√∫do do app (igual ao anterior) -->
        <div style="flex:1; padding:10px; overflow-y:auto;" id="chatBox"></div>
        
        <div style="padding:10px; background:white;">
            <div style="display:flex; gap:10px; background:#f5f5f5; padding:10px; border-radius:20px;">
                <input id="chatInput" placeholder="Mensagem..." style="flex:1; border:none; background:transparent; padding:10px;">
                <button onclick="enviarChat()" style="background:#ff4f87; color:white; border:none; width:40px; height:40px; border-radius:50%;">‚úà</button>
            </div>
        </div>
    </div>

<script>
// CONFIGURA√á√ÉO FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyAsK3kEuustv7KyoQXR0Ep-whTpDCDa03w",
    authDomain: "manuu-c23a7.firebaseapp.com",
    databaseURL: "https://manuu-c23a7-default-rtdb.firebaseio.com",
    projectId: "manuu-c23a7",
    storageBucket: "manuu-c23a7.firebasestorage.app",
    messagingSenderId: "378235951611",
    appId: "1:378235951611:web:72c855fbb5ccdb1a84535e"
};

// INICIALIZA
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
const messaging = firebase.messaging();

let user = null;
let myNick = localStorage.getItem('v3_nick');

// FUN√á√ÉO CR√çTICA PARA GITHUB PAGES
async function ativarNotificacoes() {
    const statusDiv = document.getElementById('status-aviso');
    
    try {
        // 1. Solicita permiss√£o
        const permission = await Notification.requestPermission();
        
        if (permission === 'granted') {
            statusDiv.textContent = '‚úÖ Permiss√£o concedida!';
            
            // 2. Registra Service Worker (Caminho relativo para GitHub Pages)
            const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js', {
                scope: './'
            });
            console.log('Service Worker registrado:', registration);
            
            // 3. Aguarda Service Worker estar ativo
            await navigator.serviceWorker.ready;
            
            // 4. Obt√©m token
            const token = await messaging.getToken({
                vapidKey: 'BPn6ATIl_Rjnxsn8yiRCQBZ2XtisDs5qIW6hiq391z6YTYEtKyY9OQfVAgs2y6v3siAamzjyRDjTMrDSzbm9uY0',
                serviceWorkerRegistration: registration
            });
            
            if (token) {
                statusDiv.textContent = 'üéâ Notifica√ß√µes ativadas!';
                await db.ref('tokens_pwa').child(user?.uid || 'anonimo').set(token);
            }
        } else {
            statusDiv.textContent = '‚ùå Permiss√£o negada';
        }
    } catch (error) {
        console.error('Erro:', error);
        statusDiv.textContent = '‚ùå Erro: ' + error.message;
    }
}

// Resto do c√≥digo JavaScript (igual ao anterior, mas simplificado para mobile)
auth.onAuthStateChanged(u => {
    if(u) {
        user = u;
        if(!myNick) {
            document.getElementById('btn-google').style.display = "none";
            document.getElementById('nickname-box').style.display = "block";
        } else {
            iniciarApp();
        }
    }
});

function salvarNick() {
    const nick = document.getElementById('nickInput').value.trim();
    if(nick) {
        myNick = nick;
        localStorage.setItem('v3_nick', nick);
        iniciarApp();
    }
}

function iniciarApp() {
    document.getElementById('login-screen').style.display = "none";
    document.getElementById('app-wrapper').style.display = "flex";
    
    // Contador de dias
    const inicio = new Date("2025-02-26");
    setInterval(() => {
        const dias = Math.floor((new Date() - inicio) / 86400000);
        document.getElementById('contador').textContent = `‚ù§Ô∏è ${dias} dias juntos`;
    }, 1000);
    
    // Carrega mensagens
    db.ref('chat_v3').on('value', snapshot => {
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML = "";
        snapshot.forEach(child => {
            const msg = child.val();
            chatBox.innerHTML += `<div style="background:${msg.uid===user.uid?'#ff4f87':'white'}; color:${msg.uid===user.uid?'white':'black'}; padding:10px; margin:5px; border-radius:10px; max-width:80%; ${msg.uid===user.uid?'margin-left:auto':'margin-right:auto'}">${msg.nick}: ${msg.txt}</div>`;
        });
        chatBox.scrollTop = chatBox.scrollHeight;
    });
}

function enviarChat() {
    const texto = document.getElementById('chatInput').value;
    if(texto && user) {
        db.ref('chat_v3').push({
            uid: user.uid,
            nick: myNick,
            txt: texto,
            timestamp: Date.now()
        });
        document.getElementById('chatInput').value = "";
    }
}

// Registra Service Worker ao carregar
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./firebase-messaging-sw.js')
            .then(reg => console.log('SW registrado no load:', reg))
            .catch(err => console.log('SW erro:', err));
    });
}
</script>
</body>
</html>
